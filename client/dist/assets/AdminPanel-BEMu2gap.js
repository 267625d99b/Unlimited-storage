import{a as s,j as a,D as e,b as l,E as i,G as n,F as t,H as c,c as d,v as r,x as o,u,I as h,A as x,k as j,J as m,K as p,f as v,L as N,l as b,d as g}from"./index-BIUdtEPv.js";import{r as y}from"./vendor-X31hiD63.js";import"./icons-jm45AAY8.js";const k="/api",f=s=>{if(!s||0===s)return"0 B";const a=Math.floor(Math.log(s)/Math.log(1024));return parseFloat((s/Math.pow(1024,a)).toFixed(2))+" "+["B","KB","MB","GB","TB"][a]},C=s=>s?new Date(s).toLocaleDateString("ar-SA",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-";function w({isOpen:w,onClose:$,currentUser:S,showToast:P}){var _,B,E,F,M,z,A,I,R,T,D,G,K,L,V,q,H;const[J,O]=y.useState("dashboard"),[U,Q]=y.useState(!1),[W,X]=y.useState(null),[Y,Z]=y.useState([]),[ss,as]=y.useState({page:1,totalPages:1,total:0}),[es,ls]=y.useState(""),[is,ns]=y.useState(null),[ts,cs]=y.useState(!1),[ds,rs]=y.useState({username:"",email:"",password:"",displayName:"",role:"user"}),[os,us]=y.useState([]),[hs,xs]=y.useState({page:1,totalPages:1,total:0}),[js,ms]=y.useState([]),ps=y.useCallback(async()=>{try{Q(!0);const a=await s.get(`${k}/admin/stats`);X(a.data)}catch(a){null==P||P("فشل في تحميل الإحصائيات","error")}finally{Q(!1)}},[P]),vs=y.useCallback(async(a=1)=>{try{Q(!0);const e=await s.get(`${k}/admin/users`,{params:{page:a,limit:20,search:es}});Z(e.data.users||[]),as(e.data.pagination||{page:1,totalPages:1,total:0})}catch(e){null==P||P("فشل في تحميل المستخدمين","error")}finally{Q(!1)}},[es,P]),Ns=y.useCallback(async(a=1)=>{try{Q(!0);const e=await s.get(`${k}/admin/activity`,{params:{page:a,limit:50}});us(e.data.logs||[]),xs(e.data.pagination||{page:1,totalPages:1,total:0})}catch(e){null==P||P("فشل في تحميل السجلات","error")}finally{Q(!1)}},[P]),bs=y.useCallback(async()=>{try{Q(!0);const a=await s.get(`${k}/admin/backups`);ms(a.data.backups||[])}catch(a){}finally{Q(!1)}},[]);if(y.useEffect(()=>{w&&("dashboard"===J?ps():"users"===J?vs():"activity"===J?Ns():"system"===J&&bs())},[w,J,ps,vs,Ns,bs]),y.useEffect(()=>{if("users"===J){const s=setTimeout(()=>vs(),300);return()=>clearTimeout(s)}},[es,J,vs]),!w)return null;const gs=s=>{switch(s){case"super_admin":return"مدير أعلى";case"admin":return"مدير";case"user":return"مستخدم";case"guest":return"زائر";default:return s}},ys=s=>{switch(s){case"active":return"نشط";case"suspended":return"موقوف";default:return s}};return a.jsx("div",{className:"admin-panel-overlay",onClick:$,children:a.jsxs("div",{className:"admin-panel",onClick:s=>s.stopPropagation(),children:[a.jsxs("div",{className:"admin-header",children:[a.jsxs("h2",{children:[a.jsx(e,{})," لوحة التحكم"]}),a.jsx("button",{className:"close-btn",onClick:$,children:a.jsx(l,{})})]}),a.jsxs("div",{className:"admin-content",children:[a.jsxs("div",{className:"admin-sidebar",children:[a.jsxs("button",{className:"dashboard"===J?"active":"",onClick:()=>O("dashboard"),children:[a.jsx(i,{})," الرئيسية"]}),a.jsxs("button",{className:"users"===J?"active":"",onClick:()=>O("users"),children:[a.jsx(n,{})," المستخدمين"]}),a.jsxs("button",{className:"activity"===J?"active":"",onClick:()=>O("activity"),children:[a.jsx(t,{})," سجل النشاط"]}),"super_admin"===(null==S?void 0:S.role)&&a.jsxs("button",{className:"system"===J?"active":"",onClick:()=>O("system"),children:[a.jsx(c,{})," النظام"]})]}),a.jsxs("div",{className:"admin-main",children:[U&&a.jsx("div",{className:"admin-loading",children:a.jsx("div",{className:"spinner"})}),"dashboard"===J&&W&&a.jsxs("div",{className:"dashboard-tab",children:[a.jsx("h3",{children:"نظرة عامة"}),a.jsxs("div",{className:"stats-grid",children:[a.jsxs("div",{className:"stat-card",children:[a.jsx("div",{className:"stat-icon users",children:a.jsx(n,{})}),a.jsxs("div",{className:"stat-info",children:[a.jsx("span",{className:"stat-value",children:(null==(_=W.users)?void 0:_.total)||0}),a.jsx("span",{className:"stat-label",children:"إجمالي المستخدمين"})]})]}),a.jsxs("div",{className:"stat-card",children:[a.jsx("div",{className:"stat-icon files",children:a.jsx(d,{})}),a.jsxs("div",{className:"stat-info",children:[a.jsx("span",{className:"stat-value",children:(null==(B=W.storage)?void 0:B.totalFiles)||0}),a.jsx("span",{className:"stat-label",children:"إجمالي الملفات"})]})]}),a.jsxs("div",{className:"stat-card",children:[a.jsx("div",{className:"stat-icon folders",children:a.jsx(r,{})}),a.jsxs("div",{className:"stat-info",children:[a.jsx("span",{className:"stat-value",children:(null==(E=W.storage)?void 0:E.totalFolders)||0}),a.jsx("span",{className:"stat-label",children:"إجمالي المجلدات"})]})]}),a.jsxs("div",{className:"stat-card",children:[a.jsx("div",{className:"stat-icon storage",children:a.jsx(o,{})}),a.jsxs("div",{className:"stat-info",children:[a.jsx("span",{className:"stat-value",children:f((null==(F=W.storage)?void 0:F.totalSize)||0)}),a.jsx("span",{className:"stat-label",children:"حجم التخزين"})]})]})]}),a.jsxs("div",{className:"stats-details",children:[a.jsxs("div",{className:"detail-card",children:[a.jsx("h4",{children:"المستخدمين حسب الدور"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("span",{children:"مدير أعلى"}),a.jsx("span",{children:(null==(z=null==(M=W.users)?void 0:M.byRole)?void 0:z.superAdmin)||0})]}),a.jsxs("li",{children:[a.jsx("span",{children:"مدير"}),a.jsx("span",{children:(null==(I=null==(A=W.users)?void 0:A.byRole)?void 0:I.admin)||0})]}),a.jsxs("li",{children:[a.jsx("span",{children:"مستخدم"}),a.jsx("span",{children:(null==(T=null==(R=W.users)?void 0:R.byRole)?void 0:T.user)||0})]}),a.jsxs("li",{children:[a.jsx("span",{children:"زائر"}),a.jsx("span",{children:(null==(G=null==(D=W.users)?void 0:D.byRole)?void 0:G.guest)||0})]})]})]}),a.jsxs("div",{className:"detail-card",children:[a.jsx("h4",{children:"حالة المستخدمين"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("span",{className:"status-active",children:"نشط"}),a.jsx("span",{children:(null==(L=null==(K=W.users)?void 0:K.byStatus)?void 0:L.active)||0})]}),a.jsxs("li",{children:[a.jsx("span",{className:"status-suspended",children:"موقوف"}),a.jsx("span",{children:(null==(q=null==(V=W.users)?void 0:V.byStatus)?void 0:q.suspended)||0})]})]})]}),a.jsxs("div",{className:"detail-card",children:[a.jsx("h4",{children:"المحذوفات"}),a.jsx("ul",{children:a.jsxs("li",{children:[a.jsx("span",{children:"عناصر في سلة المحذوفات"}),a.jsx("span",{children:(null==(H=W.storage)?void 0:H.trashItems)||0})]})})]})]}),"super_admin"===(null==S?void 0:S.role)&&a.jsxs("div",{className:"quick-actions",children:[a.jsx("h4",{children:"إجراءات سريعة"}),a.jsxs("button",{onClick:async()=>{var a,e;try{const a=await s.post(`${k}/admin/assign-orphan-files`);null==P||P(a.data.message,"success"),ps()}catch(l){null==P||P((null==(e=null==(a=l.response)?void 0:a.data)?void 0:e.error)||"فشل في ربط الملفات","error")}},children:[a.jsx(u,{})," ربط الملفات بدون مالك"]})]})]}),"users"===J&&a.jsxs("div",{className:"users-tab",children:[a.jsxs("div",{className:"tab-header",children:[a.jsx("h3",{children:"إدارة المستخدمين"}),a.jsxs("button",{className:"add-btn",onClick:()=>cs(!0),children:[a.jsx(h,{})," إضافة مستخدم"]})]}),a.jsxs("div",{className:"search-bar",children:[a.jsx(x,{}),a.jsx("input",{type:"text",placeholder:"البحث عن مستخدم...",value:es,onChange:s=>ls(s.target.value)})]}),a.jsx("div",{className:"users-table",children:a.jsxs("table",{children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"المستخدم"}),a.jsx("th",{children:"البريد"}),a.jsx("th",{children:"الدور"}),a.jsx("th",{children:"الحالة"}),a.jsx("th",{children:"تاريخ الإنشاء"}),a.jsx("th",{children:"الإجراءات"})]})}),a.jsx("tbody",{children:Y.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:a.jsxs("div",{className:"user-cell",children:[a.jsx("span",{className:"username",children:e.username}),e.displayName&&a.jsx("small",{children:e.displayName})]})}),a.jsx("td",{children:e.email||"-"}),a.jsx("td",{children:a.jsx("span",{className:`role-badge ${e.role}`,children:gs(e.role)})}),a.jsx("td",{children:a.jsx("span",{className:`status-badge ${e.status}`,children:ys(e.status)})}),a.jsx("td",{children:C(e.createdAt)}),a.jsx("td",{children:a.jsxs("div",{className:"action-btns",children:[a.jsx("button",{title:"تعديل",onClick:()=>ns(e),children:a.jsx(j,{})}),a.jsx("button",{title:"إعادة تعيين كلمة المرور",onClick:()=>(async a=>{var e,l;const i=prompt("أدخل كلمة المرور الجديدة:");if(i)try{await s.post(`${k}/admin/users/${a}/reset-password`,{newPassword:i}),null==P||P("تم إعادة تعيين كلمة المرور","success")}catch(n){null==P||P((null==(l=null==(e=n.response)?void 0:e.data)?void 0:l.error)||"فشل في إعادة تعيين كلمة المرور","error")}})(e.id),children:a.jsx(m,{})}),a.jsx("button",{title:"active"===e.status?"إيقاف":"تفعيل",onClick:()=>(async(a,e)=>{var l,i;try{"active"===e?(await s.post(`${k}/admin/users/${a}/suspend`),null==P||P("تم إيقاف الحساب","success")):(await s.post(`${k}/admin/users/${a}/activate`),null==P||P("تم تفعيل الحساب","success")),vs()}catch(n){null==P||P((null==(i=null==(l=n.response)?void 0:l.data)?void 0:i.error)||"فشل في تغيير حالة المستخدم","error")}})(e.id,e.status),children:"active"===e.status?a.jsx(m,{}):a.jsx(p,{})}),e.id!==(null==S?void 0:S.id)&&a.jsx("button",{title:"حذف",className:"delete",onClick:()=>(async a=>{var e,l;if(confirm("هل أنت متأكد من حذف هذا المستخدم؟"))try{await s.delete(`${k}/admin/users/${a}`),null==P||P("تم حذف المستخدم","success"),vs()}catch(i){null==P||P((null==(l=null==(e=i.response)?void 0:e.data)?void 0:l.error)||"فشل في حذف المستخدم","error")}})(e.id),children:a.jsx(v,{})})]})})]},e.id))})]})}),ss.totalPages>1&&a.jsxs("div",{className:"pagination",children:[a.jsx("button",{disabled:ss.page<=1,onClick:()=>vs(ss.page-1),children:a.jsx(N,{})}),a.jsxs("span",{children:[ss.page," / ",ss.totalPages]}),a.jsx("button",{disabled:ss.page>=ss.totalPages,onClick:()=>vs(ss.page+1),children:a.jsx(b,{})})]})]}),"activity"===J&&a.jsxs("div",{className:"activity-tab",children:[a.jsx("h3",{children:"سجل النشاط"}),a.jsxs("div",{className:"activity-list",children:[os.map((s,e)=>a.jsxs("div",{className:"activity-item",children:[a.jsx("div",{className:"activity-icon",children:a.jsx(i,{})}),a.jsxs("div",{className:"activity-info",children:[a.jsx("span",{className:"activity-action",children:s.action}),a.jsx("span",{className:"activity-target",children:s.target_name||s.target_id}),a.jsx("span",{className:"activity-user",children:s.user_id})]}),a.jsx("div",{className:"activity-time",children:C(s.created_at)})]},e)),0===os.length&&a.jsxs("div",{className:"empty-state",children:[a.jsx(i,{size:48}),a.jsx("p",{children:"لا توجد سجلات"})]})]}),hs.totalPages>1&&a.jsxs("div",{className:"pagination",children:[a.jsx("button",{disabled:hs.page<=1,onClick:()=>Ns(hs.page-1),children:a.jsx(N,{})}),a.jsxs("span",{children:[hs.page," / ",hs.totalPages]}),a.jsx("button",{disabled:hs.page>=hs.totalPages,onClick:()=>Ns(hs.page+1),children:a.jsx(b,{})})]})]}),"system"===J&&"super_admin"===(null==S?void 0:S.role)&&a.jsxs("div",{className:"system-tab",children:[a.jsx("h3",{children:"إدارة النظام"}),a.jsxs("div",{className:"system-section",children:[a.jsx("h4",{children:"النسخ الاحتياطية"}),a.jsxs("button",{className:"backup-btn",onClick:async()=>{try{await s.post(`${k}/admin/backups`),null==P||P("تم إنشاء نسخة احتياطية","success"),bs()}catch(a){null==P||P("فشل في إنشاء النسخة الاحتياطية","error")}},children:[a.jsx(g,{})," إنشاء نسخة احتياطية"]}),a.jsxs("div",{className:"backups-list",children:[js.map((s,e)=>a.jsxs("div",{className:"backup-item",children:[a.jsx(c,{}),a.jsx("span",{className:"backup-name",children:s.name}),a.jsx("span",{className:"backup-size",children:f(s.size)}),a.jsx("span",{className:"backup-date",children:C(s.created)})]},e)),0===js.length&&a.jsx("p",{className:"no-backups",children:"لا توجد نسخ احتياطية"})]})]})]})]})]}),ts&&a.jsx("div",{className:"modal-overlay",onClick:()=>cs(!1),children:a.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsx("h3",{children:"إضافة مستخدم جديد"}),a.jsx("button",{onClick:()=>cs(!1),children:a.jsx(l,{})})]}),a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"اسم المستخدم *"}),a.jsx("input",{type:"text",value:ds.username,onChange:s=>rs({...ds,username:s.target.value}),placeholder:"اسم المستخدم"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"البريد الإلكتروني"}),a.jsx("input",{type:"email",value:ds.email,onChange:s=>rs({...ds,email:s.target.value}),placeholder:"البريد الإلكتروني"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"كلمة المرور *"}),a.jsx("input",{type:"password",value:ds.password,onChange:s=>rs({...ds,password:s.target.value}),placeholder:"كلمة المرور"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"الاسم الظاهر"}),a.jsx("input",{type:"text",value:ds.displayName,onChange:s=>rs({...ds,displayName:s.target.value}),placeholder:"الاسم الظاهر"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"الدور"}),a.jsxs("select",{value:ds.role,onChange:s=>rs({...ds,role:s.target.value}),children:[a.jsx("option",{value:"user",children:"مستخدم"}),a.jsx("option",{value:"admin",children:"مدير"}),"super_admin"===(null==S?void 0:S.role)&&a.jsx("option",{value:"super_admin",children:"مدير أعلى"})]})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{className:"cancel-btn",onClick:()=>cs(!1),children:"إلغاء"}),a.jsx("button",{className:"submit-btn",onClick:async()=>{var a,e;try{await s.post(`${k}/admin/users`,ds),null==P||P("تم إنشاء المستخدم بنجاح","success"),cs(!1),rs({username:"",email:"",password:"",displayName:"",role:"user"}),vs()}catch(l){null==P||P((null==(e=null==(a=l.response)?void 0:a.data)?void 0:e.error)||"فشل في إنشاء المستخدم","error")}},children:"إنشاء"})]})]})}),is&&a.jsx("div",{className:"modal-overlay",onClick:()=>ns(null),children:a.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("h3",{children:["تعديل المستخدم: ",is.username]}),a.jsx("button",{onClick:()=>ns(null),children:a.jsx(l,{})})]}),a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"الاسم الظاهر"}),a.jsx("input",{type:"text",defaultValue:is.displayName,id:"edit-displayName",placeholder:"الاسم الظاهر"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{children:"الدور"}),a.jsxs("select",{defaultValue:is.role,id:"edit-role",children:[a.jsx("option",{value:"user",children:"مستخدم"}),a.jsx("option",{value:"admin",children:"مدير"}),"super_admin"===(null==S?void 0:S.role)&&a.jsx("option",{value:"super_admin",children:"مدير أعلى"})]})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{className:"cancel-btn",onClick:()=>ns(null),children:"إلغاء"}),a.jsx("button",{className:"submit-btn",onClick:()=>{const a=document.getElementById("edit-displayName").value,e=document.getElementById("edit-role").value;(async(a,e)=>{var l,i;try{await s.patch(`${k}/admin/users/${a}`,e),null==P||P("تم تحديث المستخدم","success"),vs(),ns(null)}catch(n){null==P||P((null==(i=null==(l=n.response)?void 0:l.data)?void 0:i.error)||"فشل في تحديث المستخدم","error")}})(is.id,{displayName:a,role:e})},children:"حفظ"})]})]})})]})})}export{w as default};
